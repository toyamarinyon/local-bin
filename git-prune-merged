#!/usr/bin/env bash
set -euo pipefail

base="${1:-main}"

# Always initialize variables so empty values are OK
merged_branches=""
orphaned_branches=""

# Get merged branches
merged_branches="$(
  git branch --merged "$base" --format='%(refname:short)' \
    | grep -vE "^(${base}|master)$" || true
)"

# Get branches currently used by worktrees
worktree_branches="$(
  git worktree list --porcelain | grep '^branch ' | sed 's/^branch refs\/heads\///' || true
)"

# Branches from removed worktrees (all branches minus currently used ones)
orphaned_branches="$(
  git branch --format='%(refname:short)' \
    | grep -vE "^(${base}|master)$" \
    | while read -r branch; do
        # Branch not used by any worktree and not merged
        if ! echo "$worktree_branches" | grep -qx "$branch" 2>/dev/null; then
          if ! echo "$merged_branches" | grep -qx "$branch" 2>/dev/null; then
            # Optional: check whether worktree metadata exists
            if git config --get-regexp "^branch\.$branch\.worktree" >/dev/null 2>&1; then
              echo "$branch"
            fi
          fi
        fi
      done || true
)"

# Merge and dedupe
all_branches="$(
  { echo "$merged_branches"; echo "$orphaned_branches"; } | sort -u | grep -v '^$' || true
)"

# Check whether the branch list is empty
if [ -z "${all_branches}" ]; then
  echo "âœ¨ å‰Šé™¤å€™è£œã®ãƒ–ãƒ©ãƒ³ãƒã¯ã‚ã‚Šã¾ã›ã‚“ã€‚"
  exit 0
fi

echo "ğŸ“ å‰Šé™¤å¯¾è±¡ã®ãƒ–ãƒ©ãƒ³ãƒ:"
echo

# Show merged branches
if [ -n "$merged_branches" ]; then
  echo "ğŸ”€ ãƒãƒ¼ã‚¸æ¸ˆã¿ (åŸºæº–: ${base}):"
  echo "$merged_branches" | sed 's/^/   /'
  echo
fi

# Show branches from removed worktrees
if [ -n "$orphaned_branches" ]; then
  echo "ğŸ—‘ï¸  å‰Šé™¤æ¸ˆã¿worktreeã®ãƒ–ãƒ©ãƒ³ãƒ:"
  echo "$orphaned_branches" | sed 's/^/   /'
  echo
fi

read -r -p "æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ [y/N]: " ans
case "${ans}" in
  [Yy]*)
    # Delete merged branches with -d; removed-worktree branches with -D
    if [ -n "$merged_branches" ]; then
      echo "$merged_branches" | xargs -r git branch -d
    fi
    if [ -n "$orphaned_branches" ]; then
      echo "âš ï¸  å‰Šé™¤æ¸ˆã¿worktreeã®ãƒ–ãƒ©ãƒ³ãƒã‚’å¼·åˆ¶å‰Šé™¤ã—ã¾ã™..."
      echo "$orphaned_branches" | xargs -r git branch -D
    fi
    echo "ğŸ§¹ å‰Šé™¤ã—ã¾ã—ãŸã€‚"
    ;;
  *)
    echo "ğŸš« ä¸­æ­¢ã—ã¾ã—ãŸã€‚"
    ;;
esac
