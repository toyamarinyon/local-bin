#!/usr/bin/env bash
set -euo pipefail

base="${1:-main}"

# ç©ºã§ã‚‚OKãªã‚ˆã†ã«ã€å¤‰æ•°ã¯å¿…ãšåˆæœŸåŒ–
merged_branches=""
orphaned_branches=""

# ãƒãƒ¼ã‚¸æ¸ˆã¿ãƒ–ãƒ©ãƒ³ãƒã‚’å–å¾—
merged_branches="$(
  git branch --merged "$base" --format='%(refname:short)' \
    | grep -vE "^(${base}|master)$" || true
)"

# ç¾åœ¨ã®worktreeã§ä½¿ç”¨ä¸­ã®ãƒ–ãƒ©ãƒ³ãƒã‚’å–å¾—
worktree_branches="$(
  git worktree list --porcelain | grep '^branch ' | sed 's/^branch refs\/heads\///' || true
)"

# å‰Šé™¤æ¸ˆã¿worktreeã®ãƒ–ãƒ©ãƒ³ãƒï¼ˆå…¨ãƒ–ãƒ©ãƒ³ãƒã‹ã‚‰ç¾åœ¨ä½¿ç”¨ä¸­ã‚’é™¤å¤–ï¼‰
orphaned_branches="$(
  git branch --format='%(refname:short)' \
    | grep -vE "^(${base}|master)$" \
    | while read -r branch; do
        # worktreeã§ä½¿ç”¨ä¸­ã§ãªã„ã€ã‹ã¤ãƒãƒ¼ã‚¸æ¸ˆã¿ã§ãªã„ãƒ–ãƒ©ãƒ³ãƒ
        if ! echo "$worktree_branches" | grep -qx "$branch" 2>/dev/null; then
          if ! echo "$merged_branches" | grep -qx "$branch" 2>/dev/null; then
            # worktreeã®å±¥æ­´ãŒã‚ã‚‹ã‹ç¢ºèªï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
            if git config --get-regexp "^branch\.$branch\.worktree" >/dev/null 2>&1; then
              echo "$branch"
            fi
          fi
        fi
      done || true
)"

# é‡è¤‡ã‚’é™¤ã„ã¦çµåˆ
all_branches="$(
  { echo "$merged_branches"; echo "$orphaned_branches"; } | sort -u | grep -v '^$' || true
)"

# branches ãŒç©ºã‹ã©ã†ã‹ã®ãƒã‚§ãƒƒã‚¯
if [ -z "${all_branches}" ]; then
  echo "âœ¨ å‰Šé™¤å€™è£œã®ãƒ–ãƒ©ãƒ³ãƒã¯ã‚ã‚Šã¾ã›ã‚“ã€‚"
  exit 0
fi

echo "ğŸ“ å‰Šé™¤å¯¾è±¡ã®ãƒ–ãƒ©ãƒ³ãƒ:"
echo

# ãƒãƒ¼ã‚¸æ¸ˆã¿ãƒ–ãƒ©ãƒ³ãƒã®è¡¨ç¤º
if [ -n "$merged_branches" ]; then
  echo "ğŸ”€ ãƒãƒ¼ã‚¸æ¸ˆã¿ (åŸºæº–: ${base}):"
  echo "$merged_branches" | sed 's/^/   /'
  echo
fi

# å‰Šé™¤æ¸ˆã¿worktreeã®ãƒ–ãƒ©ãƒ³ãƒã®è¡¨ç¤º
if [ -n "$orphaned_branches" ]; then
  echo "ğŸ—‘ï¸  å‰Šé™¤æ¸ˆã¿worktreeã®ãƒ–ãƒ©ãƒ³ãƒ:"
  echo "$orphaned_branches" | sed 's/^/   /'
  echo
fi

read -r -p "æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ [y/N]: " ans
case "${ans}" in
  [Yy]*)
    # ãƒãƒ¼ã‚¸æ¸ˆã¿ã¯ -d ã§ã€å‰Šé™¤æ¸ˆã¿worktreeã¯ -D ã§å‰Šé™¤
    if [ -n "$merged_branches" ]; then
      echo "$merged_branches" | xargs -r git branch -d
    fi
    if [ -n "$orphaned_branches" ]; then
      echo "âš ï¸  å‰Šé™¤æ¸ˆã¿worktreeã®ãƒ–ãƒ©ãƒ³ãƒã‚’å¼·åˆ¶å‰Šé™¤ã—ã¾ã™..."
      echo "$orphaned_branches" | xargs -r git branch -D
    fi
    echo "ğŸ§¹ å‰Šé™¤ã—ã¾ã—ãŸã€‚"
    ;;
  *)
    echo "ğŸš« ä¸­æ­¢ã—ã¾ã—ãŸã€‚"
    ;;
esac
