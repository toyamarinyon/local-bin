
#!/usr/bin/env bash
set -euo pipefail

PREFIX="${1:-stsh}"
DEFAULT_BRANCH="${DEFAULT_BRANCH:-main}"

die() { echo "âŒ $*" >&2; exit 1; }

REPO_ROOT="$(git rev-parse --show-toplevel 2>/dev/null)" || die "Not a git repository."
cd "$REPO_ROOT"

echo "ğŸ” Fetching..."
git fetch --prune origin

echo "ğŸ” Scanning worktrees under: ${REPO_ROOT}/worktrees/${PREFIX}"

# `git worktree list --porcelain` ã‚’ 1 è¡Œãšã¤å‡¦ç†ï¼ˆmapfileä¸è¦ï¼‰
git worktree list --porcelain | while IFS= read -r line; do
  case "$line" in
    worktree\ *)
      WT_PATH="${line#worktree }"

      # main working treeï¼ˆrepo rootï¼‰ã¯ skip
      if [[ "$WT_PATH" == "$REPO_ROOT" ]]; then
        continue
      fi

      # prefix é…ä¸‹ã ã‘å¯¾è±¡
      case "$WT_PATH" in
        *"/worktrees/${PREFIX}/"*) ;;
        *) continue ;;
      esac

      # worktreeå´ã®ãƒ–ãƒ©ãƒ³ãƒåå–å¾—ï¼ˆdetached ã¯ç©ºï¼‰
      BRANCH="$(git -C "$WT_PATH" symbolic-ref --short HEAD 2>/dev/null || true)"
      [[ -n "$BRANCH" ]] || continue

      # prefix ãƒ–ãƒ©ãƒ³ãƒã ã‘å¯¾è±¡
      case "$BRANCH" in
        "${PREFIX}/"*) ;;
        *) continue ;;
      esac

      # origin/<default> ã«ãƒãƒ¼ã‚¸æ¸ˆã¿ãªã‚‰å‰Šé™¤
      if git merge-base --is-ancestor "$BRANCH" "origin/${DEFAULT_BRANCH}"; then
        echo "ğŸ§¹ Removing merged worktree: $WT_PATH  (branch: $BRANCH)"
        git worktree remove --force "$WT_PATH"
        # ãƒ–ãƒ©ãƒ³ãƒã‚‚æ¶ˆã™ï¼ˆæ®‹ã—ãŸã„ãªã‚‰æ¬¡è¡Œã‚’ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆï¼‰
        git branch -D "$BRANCH" >/dev/null 2>&1 || true
      fi
      ;;
  esac
done

echo "ğŸ§½ Pruning..."
git worktree prune
echo "âœ… Done"
