
#!/usr/bin/env bash
set -euo pipefail

PREFIX="${1:-stsh}"
DEFAULT_BRANCH="${DEFAULT_BRANCH:-main}"

die() { echo "âŒ $*" >&2; exit 1; }

REPO_ROOT="$(git rev-parse --show-toplevel 2>/dev/null)" || die "Not a git repository."
cd "$REPO_ROOT"

echo "ðŸ” Fetching..."
git fetch --prune origin

echo "ðŸ” Scanning worktrees under: ${REPO_ROOT}/worktrees/${PREFIX}"

# Process `git worktree list --porcelain` line by line (no mapfile needed)
git worktree list --porcelain | while IFS= read -r line; do
  case "$line" in
    worktree\ *)
      WT_PATH="${line#worktree }"

      # Skip the main working tree (repo root)
      if [[ "$WT_PATH" == "$REPO_ROOT" ]]; then
        continue
      fi

      # Only target worktrees under the prefix directory
      case "$WT_PATH" in
        *"/worktrees/${PREFIX}/"*) ;;
        *) continue ;;
      esac

      # Get the worktree's branch name (empty when detached)
      BRANCH="$(git -C "$WT_PATH" symbolic-ref --short HEAD 2>/dev/null || true)"
      [[ -n "$BRANCH" ]] || continue

      # Only target prefix branches
      case "$BRANCH" in
        "${PREFIX}/"*) ;;
        *) continue ;;
      esac

      # Remove if already merged into origin/<default>
      if git merge-base --is-ancestor "$BRANCH" "origin/${DEFAULT_BRANCH}"; then
        echo "ðŸ§¹ Removing merged worktree: $WT_PATH  (branch: $BRANCH)"
        git worktree remove --force "$WT_PATH"
        # Also delete the branch (comment out the next line to keep it)
        git branch -D "$BRANCH" >/dev/null 2>&1 || true
      fi
      ;;
  esac
done

echo "ðŸ§½ Pruning..."
git worktree prune
echo "âœ… Done"
